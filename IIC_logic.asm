//IIClogic ======================================
; ???? ????? ?? ????? I2C
IIC_START:									LDI 	OSRG, 1<<TWINT|1<<TWSTA|1<<TWEN|0<<TWIE
											STS 	TWCR, OSRG 											

IIC_S:										LDS		OSRG, TWCR
											ANDI	OSRG, 1<<TWINT			
											BREQ	IIC_S		; ???? ???? ?????????? IIC ???????? ?????
											RET
 
;-----------------------------------------------------------------------------
;???????? ???? ?? IIC 
IIC_BYTE: 								 	STS		TWDR, OSRG
											LDI		OSRG, 1<<TWINT|1<<TWEN|0<<TWIE
 											STS 	TWCR, OSRG
 
IIC_B:										LDS		OSRG, TWCR
											ANDI	OSRG, 1<<TWINT	; ???? ???? ?????????? ?????? ????			
											BREQ	IIC_B
											RET
 
;-----------------------------------------------------------------------------
; ??????? ????. 
IIC_RCV:									LDI		OSRG, 1<<TWINT|1<<TWEN|1<<TWEA|0<<TWIE
											STS 	TWCR, OSRG

IIC_R:										LDS		OSRG, TWCR
											ANDI	OSRG, 1<<TWINT			
											BREQ	IIC_R		; ???? ???? ???? ????? ??????
											RET
 
;-----------------------------------------------------------------------------
; ??????? ????????? ????. ??????? ? ????? ? ??????? ????? ?????? ?????? ? ?????????
; ??????? ? ????????? ????? ?? ???????????? ACK!!!
IIC_RCV2:									LDI		OSRG, 1<<TWINT|1<<TWEN|0<<TWEA|0<<TWIE
											STS 	TWCR, OSRG
IIC_R2:										LDS		OSRG, TWCR
											ANDI	OSRG, 1<<TWINT	; ???? ???? ???? ????? ??????		
											BREQ	IIC_R2
											RET
 
;-----------------------------------------------------------------------------
; ????????????? STOP
IIC_STOP:									LDI		OSRG,1<<TWINT|1<<TWSTO|1<<TWEN|0<<TWIE
											STS 	TWCR, OSRG 											

IIC_ST:										LDS		OSRG,TWCR
											ANDI	OSRG,1<<TWSTO			
											BREQ	IIC_ST		; ???? ???? ?? ????? ????? ????.
											RET
;-----------------------------------------------------------------------------

//==========================================================================================================

RTC_READ:									RCALL	IIC_START		; ???????? ?????
 
											LDI		OSRG, 0b10100000		; ???????? ????? ????? ?? ??????
											RCALL	IIC_BYTE
 
											LDS		OSRG, RTCAddr		; ???????? ????? ?????? ?????? ????? ??????
											RCALL	IIC_BYTE
 
											RCALL	IIC_START		; ????????? ?????
 
											LDI		OSRG,0b10100001	; ????? ????? ?????, ?? ??? ?? ??????
											RCALL	IIC_BYTE
 
											RCALL	IIC_RCV			; ??????? ?????? ???? - ???????
											LDS		OSRG,TWDR		; ??????? ?? ???????? TWIDR 
											STS		sec_o,OSRG		; ????????? ? ??????  ??? ????? ????
										;	MOV 	R1, OSRG
 
											RCALL	IIC_RCV			; ?????? ???? - ??????, ? ??? ?????
											LDS		OSRG,TWDR
											STS		min_o,OSRG
										;	MOV 	R2, OSRG
 
											RCALL	IIC_RCV2			; ?????? ???? - ????
											LDS		OSRG,TWDR
											STS		hour_o,OSRG
										;	MOV 	R3, OSRG

 
										;	RCALL	IIC_RCV			; ????????? - ?????
										;	LDS		OSRG,TWDR
										;	STS		Date_o,OSRG
 
										;	RCALL	IIC_RCV2		; ?? ? ?????????? ?????. ????????! 
										;	LDS		OSRG,TWDR		; ??? ????????? ????????? ?????! RCV2!!!
										;	STS		Mth_o,OSRG
 
IIC_RErr:									RCALL	IIC_STOP		; ???? STOP ? ?????????? ?????.
 											RCALL 	unpack
											RET	

//=========================================================================================================
RTC_WRITE:									
											RCALL 	pack
											RCALL	IIC_START		; ????? 
 
											LDI		OSRG, 0b10100000	; ????????? ????? ????? ?? ??????
 
											RCALL	IIC_BYTE		; ???????? ????? ????? ?? ??????
 
											LDS 	OSRG, RTCAddr		; ????????? ????? ?????? ?????? ?????
											RCALL	IIC_BYTE		; ???????? ????? ??????
 
											LDS		OSRG, sec_o	;Sec	; ????????? ???????
											RCALL	IIC_Byte		; ???????? ???????
 
											LDS		OSRG, min_o			;Min	; ????????? ??????
											RCALL	IIC_Byte		; ???????? ??????
 
											LDS		OSRG, hour_o	;Hr	; ????????? ????
											RCALL	IIC_Byte		; ???????? ????
 
										;	LDS		OSRG,Date_i	;Date	; ????????? ?????
										;	RCALL	IIC_Byte		; ???????? ?????
 
										;	LDS		OSRG,Mth_i	;Mth	; ????????? ?????
										;	RCALL	IIC_Byte		; ???????? ?????
 
IIC_WErr:									RCALL	IIC_STOP		; ????
 
											RET		